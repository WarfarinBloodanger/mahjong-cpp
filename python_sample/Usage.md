# Python から利用する方法

HTTP を使用して JSON 形式でデータをやり取りできる `server.exe` があります。
こちらのプログラムを起動した状態で、`requests` モジュールなどを使用して、所定のフォーマットの JSON を HTTP で投げることで
結果がレスポンスとして取得できます。

宛先: `http://localhost:8888`

## サンプルプログラムの実行方法

1. `mahjong-cpp.zip` を解凍し、中の `server.exe` を起動する。
2. `requests` モジュールを使用するので、`pip install requests` でインストールする。
3. `python sample.py` を実行する。

## リクエストデータのフォーマット

```json
{
  "version": "0.9.0",
  "zikaze": 27,
  "bakaze": 27,
  "turn": 3,
  "syanten_type": 1,
  "dora_indicators": [27],
  "flag": 63,
  "hand_tiles": [1, 1, 1, 4, 5, 6, 11, 12, 20, 20, 23, 23, 24, 30],
  "melded_blocks": [],
  "counts": [
    4, 1, 4, 4, 3, 3, 3, 4, 4, 4, 4, 3, 3, 4, 4, 4, 4, 4, 4, 4, 2, 4, 4, 2, 3,
    4, 4, 3, 4, 4, 3, 4, 4, 4, 1, 1, 1
  ]
}
```

- 牌は 0~36 の数値で表す (リクエストデータ、レスポンスデータ共通)

  - 0 ~ 8: 萬子 1~ 9
  - 9 ~ 17: 筒子 1~ 9
  - 18 ~ 26: 索子 1~ 9
  - 27: 東
  - 28: 南
  - 29: 西
  - 30: 北
  - 31: 白
  - 32: 發
  - 33: 中
  - 34: 赤五萬
  - 35: 赤五筒
  - 36: 赤五索

- version: 現在の mahjong-cpp のバージョンは 0.9.0 です。バージョンが一致していることの確認に使用します。
- zikaze: 自風牌 (東: 27, 南:28, 西:29, 北:30)
- bakaze: 場風牌 (東: 27, 南:28, 西:29, 北:30)
- turn: 現在の巡目 (1 ~ 17)
- syanten_type: (一般手:1, 七対子手:2, 国士無双手:4)
- dora_indicators: ドラ表示牌の一覧 (槓ドラ含む)
- flag: 計算の設定フラグ (ビットフラグなので、OR で複数指定可)
  - ビットフラグなので、OR で複数指定可 (例: 向聴落とし考慮、手変わり考慮のみ有効なら 1 + 2 = 3 を指定)
  - 1: 向聴落とし考慮
  - 2: 手変わり考慮
  - 4: ダブル立直考慮
  - 8: 一発考慮
  - 16: 海底撈月考慮
  - 32: 裏ドラ考慮
  - 64: 和了確率を最大化 (指定されていない場合は期待値を最大化)
- hand_tiles: 手牌を 13 枚または 14 枚指定
- counts: 34 種類の各牌の残り枚数(場に見えていない枚数)及び赤牌が残っているかどうかのフラグです。基本的には手牌とドラ表示牌を引いておけばよいですが、さらに河など場に見えている枚数を考慮したい場合はその牌の枚数を引いておきます。

  - 例: 手牌 [1,1,1,4,5,6,11,12,20,20,23,23,24,30], ドラ表示牌: [27] の場合、`counts` は以下のようになります。
  - `[4,1,4,4,3,3,3,4,4,4,4,3,3,4,4,4,4,4,4,4,2,4,4,2,3,4,4,3,4,4,3,4,4,4,1,1,1]`

    ```txt
    counts[0] ~ counts[8]: 萬子1~9の残り枚数 (五萬は赤牌も含める)
    counts[9] ~ counts[17]: 萬子1~9の残り枚数 (五筒は赤牌も含める)
    counts[18] ~ counts[26]: 萬子1~9の残り枚数 (五索は赤牌も含める)
    counts[27]: 東の残り枚数
    counts[28]: 南の残り枚数
    counts[29]: 西の残り枚数
    counts[30]: 北の残り枚数
    counts[31]: 白の残り枚数
    counts[32]: 発の残り枚数
    counts[33]: 中の残り枚数
    counts[34]: 赤五萬が残っている場合は1、残ってない場合は0
    counts[35]: 赤五筒が残っている場合は1、残ってない場合は0
    counts[36]: 赤五索が残っている場合は1、残ってない場合は0
    ```

### 副露ブロックを指定する場合

例:

```json
[
  { "type": 1, "tiles": [1, 1, 1], "discarded_tile": 1, "from": 0 },
  { "type": 2, "tiles": [4, 5, 6], "discarded_tile": 4, "from": 0 }
]
```

- `type` (副露ブロックの種類)
  - 0: ポン
  - 1: チー
  - 2: 暗槓
  - 3: 明槓
  - 4: 加槓
- `tiles` (副露ブロックの構成牌)
- `discarded_tile` (鳴いた牌)
  - 計算には使用していないので、副露ブロックの構成牌のうち、どれかを適当に指定して OK
- `from` (どのプレイヤーから鳴いたか)
  - 計算には使用していないので、0~3 のいずれかを適当に指定して OK

## レスポンスデータのフォーマット

正しいリクエストを投げると、返ってきた JSON の `response/candidates` キーに各牌の有効牌、期待値、和了確率、聴牌確率が格納されています。
例えば、今が 3 巡目の場合、`exp_values[2], win_probs[2], tenpai_probs[2]` を参照します。

- tile: 打牌する牌
- required_tiles
  - count: 残り枚数
  - tile: 有効牌
- syanten_down: 向聴戻しになるかどうか
- exp_values: 1~17 巡目における期待値
- win_probs: 1~17 巡目における和了確率
- tenpai_probs: 1~17 巡目における聴牌確率

```python
{
    "tile": 1,
    "required_tiles": [
        {"count": 3, "tile": 1},
        {"count": 4, "tile": 4},
        {"count": 3, "tile": 16},
        {"count": 3, "tile": 25},
    ],
    "syanten_down": True,
    "exp_values": [
        3891.424884520901,
        3611.387861422344,
        3324.9602806561834,
        3032.9968246078943,
        2736.61314257078,
        2437.2401686922626,
        2136.6891411450547,
        1837.2294593562674,
        1541.681958625137,
        1253.5307198421215,
        977.0571881068047,
        717.5011748665181,
        481.2542973307469,
        276.0926081180646,
        111.45663941547303,
        0.0,
        0.0,
    ],
    "win_probs": [
        0.28676429520079144,
        0.2648826688812986,
        0.2425884467324838,
        0.21996018286576025,
        0.19709834604910853,
        0.17412977831069812,
        0.15121302315346807,
        0.12854469610673472,
        0.10636710599982613,
        0.08497737871415958,
        0.06473838800697322,
        0.046091862473938344,
        0.029574116525271518,
        0.015834949744313175,
        0.005660377358490566,
        0.0,
        0.0,
    ],
    "tenpai_probs": [
        0.86033118739783,
        0.8433620793246688,
        0.8241517682984493,
        0.802380082468734,
        0.7776775927773254,
        0.7496174831278617,
        0.7177059858794518,
        0.6813711127748264,
        0.6399493574355539,
        0.5926699801291114,
        0.5386364060646058,
        0.47680417182584156,
        0.40595473676059113,
        0.32466433231730357,
        0.23126684636118597,
        0.1238095238095238,
        0.0,
    ],
}
```
